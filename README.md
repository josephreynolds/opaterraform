# opaterraform
Open Policy Agent with Terraform version 0.12.5

While trying to follow the terraform example from OPA(Open Policy Agent) documentation (https://www.openpolicyagent.org/docs/v0.10.7/terraform/) faced lot's of issue because of terraform version upgrade.


### Step 1 : Create and save a Terraform plan

create main.tf file and generate the terraform plan output file

``` terraform plan --out -no-color tfplan.output to generate the output file ```

### Step 2 :  Convert the Terraform plan into JSON (This Json format is different from one generated by tfplan)

``` terraform show -json tfplan.output | jq ".planned_values.root_module.resources  |   map ({(.type|tostring) : .}) | add" ```

### Step 3 : Write the OPA policy to check the plan
Modified the existing policy file to match as per the updated json format. I tested my update policy file here (https://play.openpolicyagent.org/)

### Step 4 :  Evaluate the OPA policy on the Terraform plan

``` opa eval --data terraform.rego --input tfplan.json "data.terraform.analysis.authz" ```

``` opa eval --data terraform.rego --input tfplan.json "data.terraform.analysis.score" ```
